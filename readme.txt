I. Что это
Это комплект утилит на Питоне, предназначенный для создания локальной копии любого дневника на diary.ru .

-- Поддерживается как старый, так и новый дизайн
-- Скачиваются как посты, так и комментарии
-- Целевой формат: набор файлов markdown (.md)
-- Открывается при помощи Obsidian, кроссплатформенно
-- Парсятся все теги
-- Устанавливаются внутренние ссылки
-- Генерируются:
---- Полный список постов (сортировка по дате), 
---- Календарь как на diary.ru,
---- Полный список тегов,
---- В файле каждого тега имеется список постов, где он проставлен
-- Можно скачать все картинки, при этом качаются как картинки в тексте, так и картинки, на которые приведены только гиперссылки
-- Корректно обрабатываются ситуации, когда часть постов для вас закрыта
-- Можно "обновлять" дневник, будут качаться только новые посты.
-- Только под Windows: можно время создания файлов постов поставить равным времени создания самих постов
-- Можно всё это добавить в гит-репозиторий, хотя это уже не входит в набор скриптов

Дополнительные функции:
-- Репост самого нового поста в телеграм. При этом скачиваются картинки и поддерживается некоторое форматирование. Если пост длинный или картинок много, пост сначала заливается на telegra.ph
-- Ручной антиспам. Если появляются комментарии в слишком старых постах, они помечаются как "подозрительные". Их можно просмотреть, пометить для удаления или сохранения. Помеченные под удаление будут массово удалены.

II. Требования
-- Питон 3.x
-- Модули согласно requirements.txt
-- Место на диске. Для моего дневника надо чуть больше 300 мб на локальную копию, если делать её самим, и ещё столько же, если будете хранить в репозитории. Это с картинками. Без картинок -- около 12 мб.
-- Поставить Obsidian (https://obsidian.md/)
-- Если вы плохи в командной строке, то поставить Visual Studio Code.
-- Мозги. Знать Питон не требуется, однако модули придётся как-то ставить.

III. Порядок настройки

Эти действия делаются только один раз.

1. Создать рабочую папку, допустим, c:\diary
2. Создать папку c:\diary\scripts
3. Распаковать или сделать чекаут данного репозитория в c:\diary\scripts\

При первом запуске скриптов будет создано необходимое дерево папок. Привожу его ниже с комментарием, где что лежит:

c:\diary\zhz00_diary_obsidian <- тут будут сами посты в формате .md
c:\diary\zhz00_diary_obsidian\pics <- тут будут картинки
c:\diary\zhz00_diary_obsidian\indexes <- тут будет список постов, канедарь и список тегов
c:\diary\zhz00_diary_obsidian\indexes\days <- тут будут вспомогательные файлы для календаря; если в какой-либо день создано несколько постов, то для этого дня генерируется отдельный список, который будет размещён в этой папке
c:\diary\zhz00_diary_obsidian\tags <- тут будут лежать файлы с тегами, и со списками постов по каждому тегу
c:\diary\zhz00_diary_obsidian\.obsidian <- конфигурация по-умолчанию для обсидиана
c:\diary\scripts <- сюда сложить питоновские файлы
c:\diary\zhz00_dump <- тут будет база постов, логи и временные файлы

IV. Порядок работы -- скачивание дневника

Запустить start.py и следуйте инструкциям. Справка по сценариям:

A. Total (default) -- скачать весь дневник от начала до конца, потом преобразовать его в Obsidian со всеми промежуточными операциями
B. Update + markup -- скачать только новые записи, потом преобразовать в Obsidian
C. Update (no markup) -- скачать только новые записи (и, возможно, картинки), не преобразовывать.
D. Download (no markup) -- скачать весь дневник от начала до конца, не преобразовать.
E. Markup -- создать папку Obsidian на основании скачанного ранее дампа (после сценариев A-D)
F. Download comments -- отдельный режим скачивания комментариев, когда дневник скачан без них

V. Change username -- задать иное имя пользователя (сохраняется в username.txt)
Если целевой дневник закрытый, то после ввода имени пользователя потребуется ввести идентификатор сессии из кукисов браузера. Как получить доступ к кукисам -- зависит от браузера. Необходим куки с именем PHPSESSID у сайта diary.ru.
W. Toggle comments enable/disable mode -- Качать или не качать комментарии. Это длительная операция, т.к. надо скачать каждый пост отдельно, а без комментариев они качаются сразу по 20 штук.
X. Toggle save html enable/disable mode (debug purpose) -- Сохранять ли промежуточные HTML файлы (для отладки)
Y. Toggle pics enable/disable mode -- Качать или не качать картинки. Если вы картинки уже скачали, то будут докачаны только новые.
Z. Quit -- выход

V. Порядок работы -- пост в телеграм

Постинг в телеграм происходит при запуске скрипта tg_start.py. Если всё настроено корректно, то никакие дальнейшие действия не нужны, постинг произойдёт автоматически.

Настройка: необходимо указать токены для бота в телеграме и для телеграфа. Записать их надо в папку zhz00_dump в файл tokens.txt .
Первая строка: токен телеграфа
Вторая строка: токен бота
Третья строка: юзернейм канала в телеге для постинга

Как добыть токен для бота: https://vc.ru/u/2789595-perec/984331-gde-vzyat-token-dlya-bota-v-telegrame
Бот должен быть администратором канала, куда вы постите (3-я строка)

Добыть токен для телеграфа не так-то просто. Я рекомендую следующую последовательность:

1. Создать аккаунт через бота @telegraph с компа
2. Войти в аккаунт через браузер
3. Подсмотреть в кукисах tph_token

См. также: https://stackoverflow.com/questions/62356634/how-to-get-access-token-of-telegrams-telegraph-account

Альтернативой этому методу является создание аккаунта через Telegraph API (createAccount), что ещё более нетривиально.

VI. Порядок работы -- антиспам

Антиспам не включает в себя анализ при помощи нейронок или типа того. Он прост как валенок. Все комментарии от Гостя, написанные в постах старше двух лет, считаются подозрительным.

Для обзора их необходимо запустить diary_edit.py . Вы увидите или сообщение о том, что спама нет, или специальный псевдо-интерфейс для пролистывания найденных комментариев.

Чтобы система заработала, необходимы следующие условия:
1. Должен быть скачан весь дневник, вместе с комментариями. Если он некоторое время не обновлялся -- это не страшно, но тогда свежий спам в обзор не попадёт.
2. Должна быть правильно настроена сессия PHPSESSID. Её надо подсмотреть и записать в username.txt или ввести в диалоге Change username. Эта сессия имеет свойство часто меняться, поэтому указывать её надо непосредственно перед работой.

В псевдо-интерфейсе можно листать комментарии и ставить на них пометки.
[ ]		листать назад и вперёд
d		пометить на удаление (или сбросить флаг, если он уже был)
x		пометить как "не спам" (или сбросить флаг, если он уже был)
q		прекратить просмотр
Enter	начать удаление

При выборе пометок "спам" и "не спам" интерфейс автоматически переходит к следующему комментарию. При этом в верхней строке будет указано, какое решение было принято по предыдущему комментарию.

Комментарий не может иметь сразу два флага. Если вы нажали "удалить", то флаг "не спам" сбросится и наоборот.

После запуска удаления сначала происходит пометка "не спам" в базе данных, и только потом начинается фактическое удаление.

Если отказаться от просмтра (q), состояние не будет сохранено и никакие изменения не внесутся ни в дневник, ни в базу.

VII. Расширенные настройки.

Файл settings.py можно настраивать вручную. Вот некоторые из них, которые могут быть полезны:

forbidden_pic_urls: укажите подстроки, которые должны быть исключены из списка картинок для скачивания. Для своего дневника я уже указал правильно. Для вашего могут понадобиться другие адреса, это вы выясните после изучения первого полного дампа.
diary_url_mode : 0 при дампе всего дневника, 1 -- при дампе по тегу (используется, если надо обновить только некоторые посты, чтобы не скачивать с нуля весь дневник)
start, stop : старт, обычно, 20. Стоп -- это смещение последней страницы+20. Если вы дампаете по тегу, то старт надо задать 1, а стоп надо задать как последнюю страницу+1. Если вы хотите дампать где-то из середины, то укажите нужный диапазон.

Скрипты могут быть запущены вручную по одному. Тогда будут применяться не стандартные настройки, а указанные в settings.py. Вам придётся вручную заменить имя пользователя по рекомендациям, указанным в самом файле. Вот назначение скриптов по отдельности:

1. download.py -- складывает посты в базу данных
2. markdown_all_diary.py -- берёт посты из базы данных, преобразует, и суёт в папку zhz00_diary_obsidian, уже в формате .md. Также она создаёт список перекрёстных ссылок и список картинок для загрузки.
3. replace_urls.py -- устанавливает перекрёстные ссылки и делает ссылки на изображения внутренними.
4. download_pics.py -- качает картинки. Если вы в настройках указали, что скачивать не нужно, то запускать тоже не нужно. Первое скачивание может быть длительным, много часов, поскольку у меня установлена пауза в 1 минуту между картинками. На моём дневнике скачивание занимает больше суток. При повторных запусках, если вы картинки не удаляли, повторно они не скачиваются. Скачиваются только новые.
5. create_indexes.py -- создаёт календарь, полный список записей, список тегов, а также списки записей по каждому тегу
6. update_times.py (только под windows) -- меняет даты создания постов так, чтобы они совпадали с датами создания файлов. При этом следует учесть, что на каждый тег создаётся отдельный файл, и этот файл будет содержать дату создания на момент запуска файла markdown_all_diary.py , таким образом, самыми новыми всегда будут являться файлы с тегами.

VIII. Известные проблемы.
-- В форматировании не поддерживаются спойлер, выравнивание, атрибуты rowspan, colspan у таблиц.
-- Первая запись может пропадать. Это связано с тем, что дайари не всегда её выдаёт.
-- Ссылки, содержащие в тексте <a ...>названия</a> специальные символы: []^|# могут обрабатываться неправильно. Об этом выдаётся предупреждение, надо проверять.
-- Если вы используете тег "None", то записи с тагим тегом будут объединены с записями без тегов
-- В дневниках со старым дизайном теги отображаются дважды, в тексте самого поста и в списке после
-- Спецсимволы внутри блока кода принудительно эскейпятся, хотя это не надо. Это проблема markdownify
-- Пустые строки в таблице (<tr></tr>) ломают форматирование
-- Гиперссылки на страницу с конкретным тегом не преобразуются во внутреннюю страницу с тем же тегом. Ссылка остаётся внешней.

IX. Авторство
Скрипты написаны мной, zHz (zHz00). Электронная почта для связи: zHz00@rambler.ru
Файлы распространяются по лицензии MIT, привожу ниже её текст.

Copyright (c) 2022-2024 zHz

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.